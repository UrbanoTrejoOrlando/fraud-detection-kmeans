{% extends 'kmeans_app/base.html' %}

{% block title %}Análisis KMeans - Resultados{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">
                    <i class="fas fa-project-diagram"></i> Resultados del Análisis KMeans
                </h3>
            </div>
            <div class="card-body">
                <!-- Formulario de parámetros -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-sliders-h"></i> Configurar Parámetros</h5>
                    </div>
                    <div class="card-body">
                        <form method="GET" action="{% url 'kmeans_analysis' %}" class="row g-3">
                            <div class="col-md-4">
                                <label for="n_clusters" class="form-label">Número de Clusters (k)</label>
                                <input type="number" class="form-control" id="n_clusters" 
                                       name="n_clusters" value="{{ n_clusters|default:'2' }}" 
                                       min="2" max="20" required>
                            </div>
                            <div class="col-md-4">
                                <label for="max_clusters" class="form-label">Máximo k para método del codo</label>
                                <input type="number" class="form-control" id="max_clusters" 
                                       name="max_clusters" value="{{ max_clusters|default:'10' }}" 
                                       min="3" max="20" required>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-play"></i> Ejecutar Análisis
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Métricas de Evaluación -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Score de Silueta</h5>
                                <div class="display-4 text-primary mb-2">
                                    {{ silhouette_score|default:"0.000" }}
                                </div>
                                <p class="card-text">
                                    <small class="text-muted">
                                        Mide la calidad de separación entre clusters<br>
                                        (Más cerca de 1 es mejor)
                                    </small>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Pureza</h5>
                                <div class="display-4 text-success mb-2">
                                    {{ purity|default:"0.00" }}%
                                </div>
                                <p class="card-text">
                                    <small class="text-muted">
                                        Porcentaje de clasificación correcta<br>
                                        dentro de cada cluster
                                    </small>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Inercia</h5>
                                <div class="display-4 text-warning mb-2">
                                    {{ inertia|default:"0.00" }}
                                </div>
                                <p class="card-text">
                                    <small class="text-muted">
                                        Suma de distancias al cuadrado<br>
                                        a los centroides más cercanos
                                    </small>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Estadísticas de Clusters -->
                {% if cluster_stats %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Distribución de Clusters</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for cluster, stats in cluster_stats.items %}
                            <div class="col-md-3 mb-3">
                                <div class="card text-center border-primary">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ cluster }}</h5>
                                        <div class="display-6 text-primary">
                                            {{ stats.size }}
                                        </div>
                                        <p class="card-text">
                                            {{ stats.percentage }}% del total
                                        </p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Gráfico de Clusters -->
                <div class="plot-container mb-4">
                    <h4 class="mb-3">
                        <i class="fas fa-chart-scatter"></i> Visualización de Clusters (PCA)
                    </h4>
                    {% if cluster_plot %}
                    <img src="data:image/png;base64,{{ cluster_plot }}" 
                         alt="Gráfico de Clusters KMeans" 
                         class="plot-img img-fluid">
                    <div class="text-center mt-2 text-muted">
                        <small>PCA aplicado a las 28 características originales</small>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Ejecute el análisis para ver el gráfico
                    </div>
                    {% endif %}
                </div>
                
                <!-- Método del Codo -->
                <div class="plot-container">
                    <h4 class="mb-3">
                        <i class="fas fa-chart-line"></i> Método del Codo para Selección de k
                    </h4>
                    {% if elbow_plot %}
                    <img src="data:image/png;base64,{{ elbow_plot }}" 
                         alt="Método del Codo" 
                         class="plot-img img-fluid">
                    <div class="mt-3">
                        <h5>Valores de Inercia:</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>k</th>
                                        {% for i in inertias %}
                                        <th>{{ forloop.counter }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Inercia</strong></td>
                                        {% for inertia_val in inertias %}
                                        <td>{{ inertia_val }}</td>
                                        {% endfor %}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Ejecute el análisis para ver el método del codo
                    </div>
                    {% endif %}
                </div>
                
                <!-- Información del Análisis -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Interpretación de Resultados</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-lightbulb text-warning"></i> Score de Silueta</h6>
                                <ul>
                                    <li><strong>1:</strong> Clusters bien separados</li>
                                    <li><strong>0:</strong> Clusters superpuestos</li>
                                    <li><strong>-1:</strong> Asignaciones incorrectas</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-lightbulb text-success"></i> Pureza</h6>
                                <ul>
                                    <li><strong>100%:</strong> Perfecta clasificación</li>
                                    <li><strong>>70%:</strong> Buen resultado</li>
                                    <li><strong><50%:</strong> Revisar número de clusters</li>
                                </ul>
                            </div>
                        </div>
                        <div class="alert alert-warning mt-3">
                            <h6><i class="fas fa-exclamation-triangle"></i> Nota Importante</h6>
                            <p class="mb-0">
                                El método del codo ayuda a determinar el número óptimo de clusters.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Función para actualizar parámetros en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    const nClustersInput = document.getElementById('n_clusters');
    const maxClustersInput = document.getElementById('max_clusters');
    
    // Asegurar que max_clusters sea mayor que n_clusters
    nClustersInput.addEventListener('change', function() {
        const nClusters = parseInt(this.value);
        const maxClusters = parseInt(maxClustersInput.value);
        
        if (maxClusters <= nClusters) {
            maxClustersInput.value = nClusters + 1;
        }
    });
    
    maxClustersInput.addEventListener('change', function() {
        const maxClusters = parseInt(this.value);
        const nClusters = parseInt(nClustersInput.value);
        
        if (maxClusters <= nClusters) {
            nClustersInput.value = maxClusters - 1;
        }
    });
});
</script>
{% endblock %}